{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<div id="app">
    <h1 style="color: gold; text-align: center;">üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÑ</h1>
    
    <!-- –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth-form" style="
        max-width: 400px;
        margin: 20px auto;
        padding: 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        {% if is_authenticated %}display: none;{% endif %}
    ">
        <h3 style="color: gold; text-align: center;">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        <div style="margin: 15px 0;">
            <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω" style="
                width: 100%;
                padding: 10px;
                margin: 5px 0;
                border: 2px solid gold;
                border-radius: 5px;
                background: rgba(255,255,255,0.1);
                color: white;
            ">
        </div>
        <div style="margin: 15px 0;">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" style="
                width: 100%;
                padding: 10px;
                margin: 5px 0;
                border: 2px solid gold;
                border-radius: 5px;
                background: rgba(255,255,255,0.1);
                color: white;
            ">
        </div>
        <button onclick="login()" style="
            width: 100%;
            padding: 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        ">–í–æ–π—Ç–∏</button>
        <div id="auth-error" style="color: #ff6b6b; margin-top: 10px; text-align: center;"></div>
        
        <div style="margin-top: 15px; font-size: 14px; color: #ccc;">
            –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:<br>
            ‚Ä¢ admin / 123<br>
            ‚Ä¢ user / password<br>
            ‚Ä¢ santa / santa2024
        </div>
    </div>
    
    <!-- –ë–ª–æ–∫ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
    <div id="auth-block" style="
        max-width: 400px;
        margin: 20px auto;
        padding: 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        text-align: center;
        {% if not is_authenticated %}display: none;{% endif %}
    ">
        <h3 style="color: gold;">üëã –ü—Ä–∏–≤–µ—Ç, <span id="current-user">{{ username }}</span>!</h3>
        <div style="margin: 15px 0;">
            <button onclick="refillBoxes()" style="
                padding: 10px 20px;
                margin: 5px;
                background: #e74c3c;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            ">
                üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ (–Ω–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ—Ä–æ–±–∫–∏)
            </button>
        </div>
        <div style="margin: 15px 0;">
            <button onclick="logout()" style="
                padding: 10px 20px;
                margin: 5px;
                background: #34495e;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            ">–í—ã–π—Ç–∏</button>
        </div>
        <div id="auth-message" style="color: #27ae60; margin-top: 10px;"></div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div style="
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px auto;
        max-width: 800px;
        display: flex;
        justify-content: space-around;
        text-align: center;
    ">
        <div>
            <div style="font-size: 24px; color: gold;" id="user-count">0</div>
            <div>–û—Ç–∫—Ä—ã—Ç–æ –≤–∞–º–∏</div>
        </div>
        <div>
            <div style="font-size: 24px; color: gold;" id="total-count">10</div>
            <div>–û—Å—Ç–∞–ª–æ—Å—å –∫–æ—Ä–æ–±–æ–∫</div>
        </div>
        <div>
            <div style="font-size: 24px; color: gold;" id="remaining-count">3</div>
            <div>–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å</div>
        </div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—Ä–æ–±–∫–∞—Ö -->
    <div style="text-align: center; margin: 10px; color: #ffcc00;">
        <small>üéÅ –û–±—ã—á–Ω—ã–µ –∫–æ—Ä–æ–±–∫–∏ | üîí –¢—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</small>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–æ—Ä–æ–±–∫–∞–º–∏ -->
    <div id="container" style="
        position: relative;
        width: 1000px;
        height: 600px;
        margin: 20px auto;
        border: 2px solid gold;
        border-radius: 10px;
        background: rgba(0,0,0,0.3);
    "></div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
    <div id="error" style="
        text-align: center;
        color: #ff6b6b;
        margin: 10px;
        min-height: 24px;
    "></div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ (–¥–ª—è —Ç–µ—Å—Ç–∞) -->
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="resetGame()" style="
            padding: 10px 30px;
            background: #7f8c8d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        ">
            –°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É (—Ç–µ—Å—Ç)
        </button>
    </div>
</div>

<script>
    let userOpened = 0;
    let totalOpened = 0;
    let isAuthenticated = {{ 'true' if is_authenticated else 'false' }};
    let currentUsername = "{{ username or '' }}";
    
    function loadBoxes() {
        fetch('/lab9/api/boxes')
            .then(r => r.json())
            .then(data => {
                userOpened = data.user_opened;
                totalOpened = data.total_opened;
                isAuthenticated = data.authenticated;
                currentUsername = data.username;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                if (isAuthenticated) {
                    document.getElementById('auth-form').style.display = 'none';
                    document.getElementById('auth-block').style.display = 'block';
                    document.getElementById('current-user').textContent = currentUsername;
                }
                
                document.getElementById('user-count').textContent = userOpened;
                document.getElementById('total-count').textContent = 10 - totalOpened;
                document.getElementById('remaining-count').textContent = 3 - userOpened;
                
                renderBoxes(data.boxes);
            })
            .catch(err => {
                document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
            });
    }
    
    function renderBoxes(boxes) {
        const container = document.getElementById('container');
        container.innerHTML = '';
        
        boxes.forEach(box => {
            const div = document.createElement('div');
            div.style.position = 'absolute';
            div.style.left = box.x + 'px';
            div.style.top = box.y + 'px';
            div.style.width = '100px';
            div.style.height = '100px';
            div.style.borderRadius = '8px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.cursor = 'pointer';
            div.style.transition = 'transform 0.2s';
            div.dataset.id = box.id;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∫–æ—Ä–æ–±–∫–∏
            let boxColor = '#e74c3c'; // –∫—Ä–∞—Å–Ω—ã–π - –æ–±—ã—á–Ω–∞—è
            let borderColor = 'gold';
            let boxSymbol = 'üéÅ';
            
            if (box.requires_auth) {
                boxColor = '#9b59b6'; // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π - —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                borderColor = '#3498db'; // —Å–∏–Ω—è—è —Ä–∞–º–∫–∞
                boxSymbol = 'üîí';
            }
            
            if (box.opened) {
                // –ö–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–µ–º-—Ç–æ
                div.style.background = '#2c3e50';
                div.style.border = '3px solid #7f8c8d';
                div.style.cursor = 'default';
                div.innerHTML = `
                    <div style="text-align: center; color: #95a5a6; font-size: 12px;">
                        –ü—É—Å—Ç–æ<br>üéÅ
                    </div>
                `;
            } else {
                // –ó–∞–∫—Ä—ã—Ç–∞—è –∫–æ—Ä–æ–±–∫–∞
                div.style.background = boxColor;
                div.style.border = `3px solid ${borderColor}`;
                
                if (userOpened >= 3) {
                    div.style.opacity = '0.5';
                    div.style.cursor = 'not-allowed';
                } else {
                    div.onmouseenter = () => div.style.transform = 'scale(1.1)';
                    div.onmouseleave = () => div.style.transform = 'scale(1)';
                    div.onclick = () => openBox(box.id, div);
                }
                
                div.innerHTML = `
                    <div style="text-align: center; color: white; font-size: 40px;">
                        ${boxSymbol}
                    </div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –∫–æ—Ä–æ–±–æ–∫, —Ç—Ä–µ–±—É—é—â–∏—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                if (box.requires_auth && !isAuthenticated) {
                    div.title = '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
                }
            }
            
            container.appendChild(div);
        });
    }
    
    function openBox(boxId, boxElement) {
        if (userOpened >= 3) return;
        
        document.getElementById('error').textContent = '';
        
        fetch('/lab9/api/open', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({box_id: boxId})
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').textContent = data.error;
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            userOpened = data.user_opened;
            totalOpened = 10 - data.remaining;
            
            document.getElementById('user-count').textContent = userOpened;
            document.getElementById('total-count').textContent = data.remaining;
            document.getElementById('remaining-count').textContent = 3 - userOpened;
            
            // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–æ–±–∫–∏ –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫
            boxElement.style.background = '#34495e';
            boxElement.style.border = '3px solid gold';
            boxElement.style.cursor = 'default';
            boxElement.onmouseenter = null;
            boxElement.onmouseleave = null;
            boxElement.onclick = null;
            
            boxElement.innerHTML = `
                <div style="text-align: center; padding: 5px;">
                    <div style="color: gold; font-size: 10px; margin-bottom: 5px;">
                        ${data.message}
                    </div>
                    <img src="${data.image}" 
                         alt="–ü–æ–¥–∞—Ä–æ–∫" 
                         style="width: 60px; height: 60px; border-radius: 5px; border: 2px solid gold;">
                </div>
            `;
            
            // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞, –±–ª–æ–∫–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ –∫–æ—Ä–æ–±–∫–∏
            if (userOpened >= 3) {
                document.getElementById('error').textContent = '–í—ã –æ—Ç–∫—Ä—ã–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–∫!';
                loadBoxes(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á—Ç–æ–±—ã –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            }
        })
        .catch(err => {
            document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏';
        });
    }
    
    function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        document.getElementById('auth-error').textContent = '';
        
        fetch('/lab9/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('auth-error').textContent = data.error;
                return;
            }
            
            document.getElementById('auth-message').textContent = data.message;
            document.getElementById('auth-error').textContent = '';
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–æ–±–∫–∏
            loadBoxes();
        });
    }
    
    function logout() {
        fetch('/lab9/api/logout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('auth-message').textContent = data.message;
                // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                document.getElementById('auth-form').style.display = 'block';
                document.getElementById('auth-block').style.display = 'none';
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–æ–±–∫–∏
                loadBoxes();
            }
        });
    }
    
    function refillBoxes() {
        if (!confirm('üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –ø–æ–¥–∞—Ä–∫–∞–º–∏ –∑–∞–Ω–æ–≤–æ! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
            return;
        }
        
        fetch('/lab9/api/refill', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').textContent = data.error;
                return;
            }
            
            document.getElementById('error').textContent = '';
            document.getElementById('auth-message').textContent = data.message;
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–æ–±–∫–∏
            setTimeout(() => {
                loadBoxes();
            }, 1000);
        });
    }
    
    function resetGame() {
        if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')) {
            fetch('/lab9/api/reset', {method: 'POST'})
                .then(() => location.reload());
        }
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–æ–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadBoxes);
</script>
{% endblock %}