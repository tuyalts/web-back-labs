{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<div id="app">
    <h1 style="color: gold; text-align: center;">üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÑ</h1>
    
    <div style="
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px auto;
        max-width: 800px;
        display: flex;
        justify-content: space-around;
        text-align: center;
    ">
        <div>
            <div style="font-size: 24px; color: gold;" id="user-count">0</div>
            <div>–û—Ç–∫—Ä—ã—Ç–æ –≤–∞–º–∏</div>
        </div>
        <div>
            <div style="font-size: 24px; color: gold;" id="total-count">10</div>
            <div>–û—Å—Ç–∞–ª–æ—Å—å –∫–æ—Ä–æ–±–æ–∫</div>
        </div>
        <div>
            <div style="font-size: 24px; color: gold;" id="remaining-count">3</div>
            <div>–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å</div>
        </div>
    </div>
    
    <div id="container" style="
        position: relative;
        width: 1000px;
        height: 600px;
        margin: 20px auto;
        border: 2px solid gold;
        border-radius: 10px;
        background: rgba(0,0,0,0.3);
    "></div>
    
    <div id="error" style="
        text-align: center;
        color: #ff6b6b;
        margin: 10px;
        min-height: 24px;
    "></div>
    
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="resetGame()" style="
            padding: 10px 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        ">
            –°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É –¥–ª—è –≤—Å–µ—Ö
        </button>
    </div>
</div>

<script>
    let userOpened = 0;
    let totalOpened = 0;
    
    function loadBoxes() {
        fetch('/lab9/api/boxes')
            .then(r => r.json())
            .then(data => {
                userOpened = data.user_opened;
                totalOpened = data.total_opened;
                
                document.getElementById('user-count').textContent = userOpened;
                document.getElementById('total-count').textContent = 10 - totalOpened;
                document.getElementById('remaining-count').textContent = 3 - userOpened;
                
                renderBoxes(data.boxes);
            })
            .catch(err => {
                document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
            });
    }
    
    function renderBoxes(boxes) {
        const container = document.getElementById('container');
        container.innerHTML = '';
        
        boxes.forEach(box => {
            const div = document.createElement('div');
            div.style.position = 'absolute';
            div.style.left = box.x + 'px';
            div.style.top = box.y + 'px';
            div.style.width = '100px';
            div.style.height = '100px';
            div.style.borderRadius = '8px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.cursor = 'pointer';
            div.style.transition = 'transform 0.2s';
            div.dataset.id = box.id;
            
            if (box.opened) {
                // –ö–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–µ–º-—Ç–æ
                div.style.background = '#2c3e50';
                div.style.border = '3px solid #7f8c8d';
                div.style.cursor = 'default';
                div.innerHTML = `
                    <div style="text-align: center; color: #95a5a6; font-size: 12px;">
                        –ü—É—Å—Ç–æ<br>üéÅ
                    </div>
                `;
            } else {
                // –ó–∞–∫—Ä—ã—Ç–∞—è –∫–æ—Ä–æ–±–∫–∞
                div.style.background = '#e74c3c';
                div.style.border = '3px solid gold';
                
                if (userOpened >= 3) {
                    div.style.opacity = '0.5';
                    div.style.cursor = 'not-allowed';
                } else {
                    div.onmouseenter = () => div.style.transform = 'scale(1.1)';
                    div.onmouseleave = () => div.style.transform = 'scale(1)';
                    div.onclick = () => openBox(box.id, div);
                }
                
                div.innerHTML = `
                    <div style="text-align: center; color: white; font-size: 40px;">
                        üéÅ
                    </div>
                `;
            }
            
            container.appendChild(div);
        });
    }
    
    function openBox(boxId, boxElement) {
        if (userOpened >= 3) return;
        
        document.getElementById('error').textContent = '';
        
        fetch('/lab9/api/open', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({box_id: boxId})
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').textContent = data.error;
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            userOpened = data.user_opened;
            totalOpened = 10 - data.remaining;
            
            document.getElementById('user-count').textContent = userOpened;
            document.getElementById('total-count').textContent = data.remaining;
            document.getElementById('remaining-count').textContent = 3 - userOpened;
            
            // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–æ–±–∫–∏ –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫
            boxElement.style.background = '#34495e';
            boxElement.style.border = '3px solid gold';
            boxElement.style.cursor = 'default';
            boxElement.onmouseenter = null;
            boxElement.onmouseleave = null;
            boxElement.onclick = null;
            
            boxElement.innerHTML = `
                <div style="text-align: center; padding: 5px;">
                    <div style="color: gold; font-size: 10px; margin-bottom: 5px;">
                        ${data.message}
                    </div>
                    <img src="${data.image}" 
                         alt="–ü–æ–¥–∞—Ä–æ–∫" 
                         style="width: 60px; height: 60px; border-radius: 5px; border: 2px solid gold;">
                </div>
            `;
            
            // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞, –±–ª–æ–∫–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ –∫–æ—Ä–æ–±–∫–∏
            if (userOpened >= 3) {
                document.getElementById('error').textContent = '–í—ã –æ—Ç–∫—Ä—ã–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–∫!';
                loadBoxes(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á—Ç–æ–±—ã –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            }
        })
        .catch(err => {
            document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏';
        });
    }
    
    function resetGame() {
        if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')) {
            fetch('/lab9/api/reset', {method: 'POST'})
                .then(() => location.reload());
        }
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–æ–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadBoxes);
</script>
{% endblock %}